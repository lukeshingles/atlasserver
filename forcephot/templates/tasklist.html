{% extends "rest_framework/base.html" %}
{% load static %}
{% load i18n %}
{% load rest_framework %}

{% block content %}
<div class="content-main" role="main" aria-label="main content">

    <div class="page-header">
    <h1>{{name}}</h1>
    </div>

    {% if not singletaskdetail %}
    <div class="newrequest">
        <div class="task">
        <h3>New request</h3>
        <form method="POST" action="{% url 'task-list' %}" id="newrequest">
            {% csrf_token %}
            {{ form.non_field_errors }}
            <ul>
                <li>{{ form.radeclist.label_tag }}
                {{ form.radeclist }}
                <a class="collapsible">Help</a><div style="display: none; clear: right; font-size: small;">Each line should consist of a right ascension and a declination coordinate in decimal or sexagesimal notation, separated by a space or a comma. Limit of 100 objects per submission. If requested, email notification will be sent only after all targets in the list have been processed.</div>
                {{ form.radeclist.errors }}
                </li>
                <li>{{ form.mjd_min.label_tag }}{{ form.mjd_min }}{{ form.mjd_min.errors }}</li>
                <li>{{ form.mjd_max.label_tag }}{{ form.mjd_max }}{{ form.mjd_max.errors }}</li>
                <li>{{ form.comment.label_tag }}{{ form.comment }}{{ form.comment.errors }}</li>
                <li>{{ form.use_reduced }}<label for="id_use_reduced">Use reduced instead of difference images</label></li>
                <li>{{ form.send_email }}<label for="id_send_email">Email me when completed</label></li>
            </ul>
            <input class="btn btn-info" type="submit" value="Request" />
        </form>
        </div>
    </div>
    {% endif %}

    <div id="tasklist"{% if singletaskdetail %} class="singletaskdetail"{% endif %}>
        {% if not tasks %}
        <p>You have no tasks yet.</p>
        {% else %}
            <ul class="tasks">
            {% include 'tasklist-tasks.html' %}
            </ul>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
    {{ block.super }}
    <script src="{% static 'js/plotly-latest.kws.js' %}"></script>

    <script language="javascript" type="text/javascript">
    var jslcdataglobal = new Object();
    var jslabelsglobal = new Object();
    var jslimitsglobal = new Object();

    // check if the next job to run has started or finished
    var updatequeuedtimer = setInterval(function(){updateQueuedTasks(true, '.notstarted');}, 1500);

    // only one task across all users will be running now, so you might as well poll it at high frequency
    var updatestartedtimer = setInterval(function(){updateQueuedTasks(false, '.started');}, 1000);

    {% if addnewtaskstotop %}
    // occaisionally check and new items from the server (if not on page > 1 or single task view)
    var checknewtimer = setInterval(checkNewTasks, 3000);
    {% endif %}

    // check if any items on the page have been deleted
    var checkdeletedtimer = setInterval(checkDeletedTasks, 15000);

    var window_active = true;

    $(window).blur(function() {
      window_active = false;
    });

    $(window).focus(function() {
      window_active = true;
      updateQueuedTasks(false, '.started');
      updateQueuedTasks(true, '.notstarted');
      {% if addnewtaskstotop %}
      checkNewTasks();
      {% endif %}
      checkDeletedTasks();
    });


    function updateQueuedTasks(require_active, class_suffix) {
        if (require_active && !window_active) {
            return;
        }

        $('li.task.queued' + class_suffix).sort(function(a, b) {
            // ascending order of task id number
            taskid_a = parseInt($(a).attr('id').replace("task-", ""));
            taskid_b = parseInt($(b).attr('id').replace("task-", ""));
            return taskid_a - taskid_b;
        })
        .slice(0, 3) // limit number of items updated. The ones that could change have the lowest id numbers
        .each(function() {
            var taskid = $(this).attr('id').replace("task-", "");

            console.log("updating " + class_suffix + " task id", taskid);
            $.get('{% url 'taskboxhtml' 9999 %}'.replace('9999', taskid),).done(function(data, status) {
                if (status == 'success') {
                    $('#task-' + taskid).replaceWith(data);
                }
            });
        });

        activate_first_plot();
    }


    function checkDeletedTasks() {
        // check all of the displayed tasks still exist on the server
        // this could cause problems for users with a giant queue unless properly paginated

        if (!window_active) {
            return;
        }

        $('li.task').each(function() {
            var taskid = $(this).attr('id').replace("task-", "");

            // this method of retrieving every item to see if it still exists
            // is probably quite expensive
            $.get('{% url 'taskboxhtml' 9999 %}'.replace('9999', taskid))
            .fail(function(jqXHR, textStatus, errorThrown){
                if(jqXHR.status == 404) {
                    $('#task-' + taskid).replaceWith('');
                    console.log('removing deleted task id ', taskid);
                }
            });
        });
    }

    function checkNewTasks() {
        if (!window_active) {
            return;
        }

        var maxtaskid = getMaxTaskId();
        // add any new tasks found on the server to the top of the page
        $.get('{% url 'taskboxhtml_newsince_taskid' 9999 %}'.replace('9999', maxtaskid)).done(function(data, status) {
            if (status == 'success') {
                var datatrim = data.trim();
                if (datatrim == "") {
                    console.log("no new tasks on server with id > " + maxtaskid);
                } else {
                    console.log("adding new task(s) from server with id > " + maxtaskid);
                    $('ul.tasks').prepend(datatrim);
                }
            }
        });


        activate_first_plot();
    }


    function getMaxTaskId() {
        var maxtaskid = -1;
        $('li.task').each(function() {
            var taskid = $(this).attr('id').replace("task-", "");
            if (parseInt(taskid) > parseInt(maxtaskid))
                maxtaskid = taskid;
        });
        return maxtaskid;
    }


    function activate_first_plot() {
        first_finished = $('li.task.finished').filter(':first');
        // make sure the plot has not already been created
        if (first_finished.find('div.plot').html() == '') {
            // automatically "click" the "show plot" button on the first completed task
            first_finished.find('a.showplot').trigger('click');
        }
    }


    activate_first_plot();
    </script>
{% endblock %}
