{% extends "rest_framework/base.html" %}
{% load static %}
{% load i18n %}
{% load rest_framework %}

{% block content %}
<div class="content-main" role="main" aria-label="main content">

    <div class="page-header">
    <h1>Job Queue</h1>
    </div>

    <div class="newrequest">
        <div class="task">
        <h3>New request</h3>
        <form method="POST" action="{% url 'task-list' %}" id="newrequest">
            {% csrf_token %}
            {{ form.non_field_errors }}
            <ul>
                <li>{{ form.radeclist.label_tag }}
                {{ form.radeclist }}
                <a class="collapsible">Help</a><div style="display: none; clear: right; font-size: small;">Each line should consist of a right ascension and a declination coordinate in decimal or sexagesimal notation, separated by a space or a comma. Limit of 100 objects per submission. If requested, email notification will be sent only after all targets in the list have been processed.</div>
                {{ form.radeclist.errors }}
                </li>
                <li>{{ form.mjd_min.label_tag }}{{ form.mjd_min }}{{ form.mjd_min.errors }}</li>
                <li>{{ form.mjd_max.label_tag }}{{ form.mjd_max }}{{ form.mjd_max.errors }}</li>
                <li>{{ form.comment.label_tag }}{{ form.comment }}{{ form.comment.errors }}</li>
                <li>{{ form.use_reduced }}<label for="id_use_reduced">Use reduced instead of difference images</label></li>
                <li>{{ form.send_email }}<label for="id_send_email">Email me when completed</label></li>
            </ul>
            <input class="btn btn-info" type="submit" value="Request" />
        </form>
        </div>
    </div>

    <div id="tasklist">
        {% if not tasks %}
        <p>You have no tasks yet.</p>
        {% else %}
            <ul class="tasks">
            {% for task in tasks %}
                {% if task.finishtimestamp %}
                <li class="task finished">
                    <a class="btn btn-sm btn-danger" href="{% url 'delete' task.id %}">Delete</a>
                {% else %}
                <li class="task queued" id="task-{{task.id}}">
                    <a class="btn btn-sm btn-danger" href="{% url 'delete' task.id %}">Cancel</a>
                {% endif %}
                    <a href="{% url 'task-detail' task.id %}">Task {{task.id}}</a><br/>
                    {% if task.user.id != request.user.id %}
                    User: {{task.user.username}} ({{task.user.email}})<br/>
                    {% endif %}
                    {% if task.comment %}
                    Comment: <b>{{task.comment}}</b><br/>
                    {% endif %}
                    RA Dec: {{task.ra}} {{task.dec}}<br/>
                    Images: {%if task.use_reduced %}Reduced{% else %}Difference{% endif %}<br/>

                    {% if task.mjd_min or task.mjd_max %}
                        MJD range: [{{task.mjd_min|default:"0"}}, {{task.mjd_max|default:"âˆž"}}]<br/>
                    {% endif %}

                    Queued at {{task.timestamp}}<br/>
                    {% if task.finishtimestamp %}
                    Finished{% if task.finishtimestamp %} at {{task.finishtimestamp}}{% endif %}<br/>
                    <a class="results btn btn-info" href="{% static task.get_localresultfile %}">Show Data</a>
                    <a class="results btn btn-info" onclick="javascript:$.getScript('{% url 'resultplotdata' task.id %}'); this.style='display: none;'">Show Plot</a>
                    <div id="plotforced-task-{{task.id}}" style="width: 100%;"></div>

                    {% else %}
                    Waiting for results ({{task.get_queuepos}} tasks ahead of this one)
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
    {{ block.super }}
    <script src="{% static 'js/plotly-latest.kws.js' %}"></script>

    <script language="javascript" type="text/javascript">
    var jslcdataglobal = new Object();
    var jslabelsglobal = new Object();
    var jslimitsglobal = new Object();
    </script>
{% endblock %}
