{% load static %}
{% load i18n %}
{% load rest_framework %}
{% load forcedphottags %}

<div id="tasklist"{% if singletaskdetail %} class="singletaskdetail"{% endif %}>
    {% if not tasks and usertaskcount == 0 %}
    <p>There are no tasks.</p>
    {% else %}
        <ul class="tasks">

            {% for task in tasks %}

              {% if task.finishtimestamp %}
                <li class="task finished" id="task-{{task.id}}"{% start_hidden task request %}>
              {% elif task.starttimestamp %}
                <li class="task queued started" id="task-{{task.id}}"{% start_hidden task request %}>
              {% else %}
                <li class="task queued notstarted" id="task-{{task.id}}"{% start_hidden task request %}>
              {% endif %}

              <div class="updatable">
                  <div class="rightside">
                      {% if task.user.id == request.user.id %}
                        <button class="btn btn-sm btn-danger" onclick="$.ajax({url: '{% url 'task-detail' task.id %}', method: 'delete', success: function (result) {updatePageTasks();}}); ">{% if task.finishtimestamp %}Delete{% else %}Cancel{% endif %}</button>
                      {% endif %}
                      {% if task.localresultpreviewimagefile %}
                      <img src="{% static task.localresultpreviewimagefile %}" style="display:block; margin-top: 1em; margin-left: 1em;" />
                      {% endif %}
                  </div>
                  <a href="{% url 'task-detail' task.id %}">Task {{task.id}}</a><br/>
                  {% if task.parent_task %}
                  <p>Image request for
                    {% if task.parent_task.is_archived %}
                    Task {{task.parent_task.id}} (deleted)
                    {% else %}
                    <a href="{% url 'task-detail' task.parent_task.id %}">Task {{task.parent_task.id}}</a>
                    {% endif %}
                  </p>
                  <p>Up to the first 500 {%if task.use_reduced %}reduced{% else %}difference{% endif %} images will be retrieved. The image request and download link may expire after one week.</p>
                  {% endif %}

                  {% if task.user.id != request.user.id %}
                  User: {{task.user.username}}<br/>
                  {% endif %}
                  {% if task.comment %}
                  Comment: <b>{{task.comment}}</b><br/>
                  {% endif %}

                  {% if task.mpc_name %}
                  MPC Object: {{task.mpc_name}}<br />
                  {% else %}
                  RA Dec{% if task.radec_epoch_year %} (epoch {{task.radec_epoch_year.normalize}}){% endif %}: {{task.ra}} {{task.dec}}<br/>
                      {% if task.propermotion_ra > 0 or propermotion_dec > 0 %}
                      Proper motion [mas/yr]: {{task.propermotion_ra}} {{task.propermotion_dec}}<br/>
                      {% endif %}
                  {% endif %}
                  Images: {%if task.use_reduced %}Reduced{% else %}Difference{% endif %}<br />

                  {% if task.mjd_min or task.mjd_max %}
                      MJD range: [{{task.mjd_min|default:"0"}}, {{task.mjd_max|default:"âˆž"}}]<br />
                  {% endif %}

                  Queued at {{task.timestamp|date:'Y-m-d H:i:s e'}}<br/>

                  {% if task.finishtimestamp %}
                    Finished{% if task.finishtimestamp %} at {{task.finishtimestamp|date:'Y-m-d H:i:s e'}}{% endif %}<br />

                    {% if task.error_msg %}
                        <br/><span style="color: black; font-weight: bold;">Error: {{ task.error_msg }}</span>
                    {% else %}
                      {% if task.request_type == 'FP' %}
                        <a class="results btn btn-info getdata" href="{% url 'taskresultdata' task.id %}" target="_blank">Data</a>
                        <a class="results btn btn-info getpdf" href="{% url 'taskpdfplot' task.id %}" target="_blank">PDF</a>
                      {% endif %}

                      {% if task.request_type == 'IMGZIP' %}
                          {% if task.localresultimagezipfile %}
                              <a class="results btn btn-info" href="{% url 'taskimagezip' task.parent_task_id}">Download images (ZIP)</a>
                          {% endif %}
                      {% elif task.imagerequest_taskid %}
                          {% if task.localresultimagezipfile %}
                              <a class="btn btn-primary" href="{% url 'task-detail' task.imagerequest_taskid %}">Images ready</a>
                          {% else %}
                              <a class="btn btn-warning" href="{% url 'task-detail' task.imagerequest_taskid %}">Images requested</a>
                          {% endif %}
                      {% elif task.user.id == request.user.id %}
                          <a class="btn btn-info" href="{% url 'requestimages' task.id %}" title="Download FITS and JPEG images for up to the first 500 observations.">Request {% if task.use_reduced %}reduced{% else %}diff{% endif %} images</a>
                      {% endif %}

                    {% endif %}
                  {% elif task.starttimestamp %}
                  <br /><span style="color: red; font-style: italic">Running (started {{task.starttimestamp|tasktimesince}})</span>
                  {% else %}
                  Waiting ({{task.queuepos}} tasks ahead of this one)
                  {% endif %}
                  </div>

                  {% if task.finishtimestamp and not task.error_msg and task.request_type == 'FP' %}
                  <div id="plotforcedflux-task-{{task.id}}" class="plot" style="width: 100%; height: 300px"></div>
                  {% endif %}
                </li>

            {% endfor %}
        </ul>
    {% endif %}

    {% if paginator %}
    <div id="paginator">
        <p id="taskcount">{% if tasks %}Showing {{tasks|length}} of {{usertaskcount}} tasks{% endif %}</p>
        {% get_pagination_html paginator %}
    </div>
    {% endif %}
</div>
