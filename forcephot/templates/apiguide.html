{% extends "rest_framework/base.html" %}

{% block content %}
<div class="content-main" role="main" aria-label="main content">
    <div class="page-header">
    <h1>API Guide</h1>
    </div>

    <p>The forced photometry server has a REST API that makes it easy to script requests. In this example, we'lll use Python.</p>

    <p>First, let's import some useful packages and set the API URL:</p>
<pre><code>import io
import os
import sys
import time

import pandas as pd
import requests

BASEURL = "https://star.pst.qub.ac.uk/sne/atlasforced"
</code></pre>

<p>Next, we need to obtain a secret token from our username and password. This usually only has to be done once, unless a token reset is specifically requested (such as if it accidentally becomes compromised).</p>
<pre><code>resp = requests.post(url=f"{BASEURL}/api-token-auth/", data={'username': "__my_username__", 'password': "__my_password__"})

if resp.status_code == 200:
    token = resp.json()['token']
    print(f'Your token is {token}')
    headers = {'Authorization': f'Token {token}'}
else:
    print(f'ERROR {resp.status_code}')
    print(resp.json())
</code></pre>

<p>Next, submit an RA and Dec to the server to obtain a URL for checking the task status.</p>
<pre><code>with requests.Session() as s:
    resp = s.post(f"{BASEURL}/queue?format=json", headers=headers, data={'ra': 44, 'dec': 22})
    if resp.status_code == 201:
        taskurl = resp.json()['url']
        print(f'Your task URL is {taskurl}')
    else:
        print(f'ERROR {resp.status_code}')
        print(resp.json())
        sys.exit()
</code></pre>

Now we can check if the task has completed, and if so, retrieve the results.
<pre><code>with requests.Session() as s:
    result_url = None
    while not result_url:
        r = s.get(taskurl, headers=headers).json()
        if r['finished']:
            result_url = r['result_url']
            print(f"Task complete with results available at {result_url}")
        else:
            print("Not finished yet. Checking again in a few seconds...")
            time.sleep(5)

    textdata = s.get(result_url, headers=headers).text
</code></pre>

<p>The raw text can be parsed into a pandas dataframe for easy manipulation.</p>
<pre><code>dfresult = pd.read_csv(StringIO(textdata.replace("###", "")), delim_whitespace=True)
print(dfresult)
</code></pre>

</div>
{% endblock %}