"use strict";var jslcdataglobal=new Object,jslabelsglobal=new Object,jslimitsglobal=new Object;class TaskPlot extends React.Component{constructor(t){super(t)}componentDidMount(){console.log("activating plot",this.props.taskid),$.ajax({url:"/queue/"+this.props.taskid+"/resultplotdata.js",cache:!0,dataType:"script"})}render(){return React.createElement("div",{key:"plot",id:"plotforcedflux-task-"+this.props.taskid,className:"plot",style:{width:"100%",height:"300px"}})}}class Task extends React.Component{constructor(t){super(t),this.state=t.taskdata,this.deleteTask=this.deleteTask.bind(this),this.state.timeelapsed=-1}deleteTask(){$.ajax({url:this.state.url,method:"delete",success:t=>{this.props.fetchData()}})}static getDerivedStateFromProps(t,e){if(null!=t.taskdata.starttimestamp&&null==t.taskdata.finishtimestamp){var s=new Date(t.taskdata.starttimestamp).getTime(),a=((new Date).getTime()-s)/1e3;t.taskdata.timeelapsed=a.toFixed(1)}return JSON.stringify(t.taskdata)!=JSON.stringify(e)?t.taskdata:null}componentDidMount(){null!=this.state.starttimestamp&&null==this.state.finishtimestamp&&(console.log(this.state.starttimestamp),this.interval=setInterval((()=>this.updateTimeElapsed()),300))}componentWillUnmount(){clearInterval(this.interval)}updateTimeElapsed(){if(null!=this.state.starttimestamp&&null==this.state.finishtimestamp){var t=new Date(this.state.starttimestamp).getTime(),e=((new Date).getTime()-t)/1e3;this.setState({timeelapsed:e.toFixed(1)})}else clearInterval(this.interval)}shouldComponentUpdate(t,e){return null!=this.state.starttimestamp&&null==this.state.finishtimestamp||JSON.stringify(e)!=JSON.stringify(this.state)}render(){var t=this.state,e="none",s="none";null!=t.finishtimestamp?(e="finished",s="Delete"):null!=t.starttimestamp?(e="queued started",s="Cancel"):(e="queued notstarted",s="Cancel"),console.log("Task "+t.id+" rendered");var a=[React.createElement("div",{key:"rightside",className:"rightside"},React.createElement("button",{className:"btn btn-sm btn-danger",onClick:this.deleteTask},s),React.createElement("img",{src:t.previewimage_url,style:{display:"block",marginTop:"1em",marginLeft:"1em"}}))];if(a.push(React.createElement("div",{key:"tasknum"},React.createElement("a",{key:"tasklink",href:t.url+"?usereact"},"Task ",t.id))),t.parent_task_url?a.push(React.createElement("p",{key:"imgrequest"},"Image request for ",React.createElement("a",{key:"parent_task_link",href:t.parent_task_url+"?usereact"},"Task ",t.parent_task_id))):t.parent_task&&a.push(React.createElement("p",{key:"imgrequest"},"Image request for Task ",t.parent_task_id," (deleted)")),t.parent_task_id){var r=t.use_reduced?"reduced":"difference";a.push(React.createElement("p",{key:"imgrequestnote"},"Up to the first 500 ",r," images will be retrieved. The image request and download link may expire after one week."))}if(t.user_id!=user_id&&a.push(React.createElement("div",{key:"user"},"User: ",t.username)),""!=t.comment&&a.push(React.createElement("div",{key:"comment"},"Comment: ",React.createElement("b",null,t.comment))),null!=t.mpc_name?a.push(React.createElement("div",{key:"target"},"MPC Object: ",t.mpc_name)):a.push(React.createElement("div",{key:"target"},"RA Dec: ",t.ra," ",t.dec)),a.push(React.createElement("div",{key:"imgtype"},"Images: ",t.use_reduced?"Reduced":"Difference")),null!=t.mjd_min||null!=t.mjd_max){var n=null!=t.mjd_min?t.mjd_min:"0",i=null!=t.mjd_max?t.mjd_max:"∞";a.push(React.createElement("div",{key:"mjdrange"},"MJD range: [",n,", ",i,"]"))}return a.push(React.createElement("div",{key:"queuetime"},"Queued at ",t.timestamp)),null!=t.finishtimestamp?(a.push(React.createElement("div",{key:"status"},"Finished at ",t.finishtimestamp)),null!=t.error_msg?a.push(React.createElement("p",{style:{color:"black",fontWeight:"bold"}},"Error: ",t.error_msg)):"FP"==t.request_type&&(a.push(React.createElement("a",{key:"datalink",className:"results btn btn-info getdata",href:t.result_url,target:"_blank"},"Data")),a.push(React.createElement("a",{key:"pdflink",className:"results btn btn-info getpdf",href:t.pdfplot_url,target:"_blank"},"PDF")))):null!=t.starttimestamp?a.push(React.createElement("div",{key:"status",style:{color:"red",fontStyle:"italic"}},"Running (started ",this.state.timeelapsed," seconds ago)")):a.push(React.createElement("div",{key:"status"},"Waiting (",t.queuepos," tasks ahead of this one)")),null!=t.finishtimestamp&&null==t.error_msg&&"FP"==t.request_type&&a.push(React.createElement(TaskPlot,{key:"plot",taskid:t.id})),React.createElement("li",{key:"task-"+t.id,className:"task "+e,id:"task-"+t.id},a)}}function getCursor(t){return null==t?null:new URL(t).searchParams.get("cursor")}class Pager extends React.Component{constructor(t){super(t),this.state={},this.state.previous=this.props.previous,this.state.next=this.props.next,this.state.pagetaskcount=this.props.pagetaskcount,this.state.taskcount=this.props.taskcount,this.state.previous_cursor=getCursor(this.props.previous),this.state.next_cursor=getCursor(this.props.next)}static getDerivedStateFromProps(t,e){var s={};return t.previous!=e.previous&&(s.previous=t.previous,s.previous_cursor=getCursor(t.previous)),t.next!=e.next&&(s.next=t.next,s.next_cursor=getCursor(t.next)),t.pagetaskcount!=e.pagetaskcount&&(s.pagetaskcount=t.pagetaskcount),t.taskcount!=e.taskcount&&(s.taskcount=t.taskcount),Object.keys(s).length>0?s:null}shouldComponentUpdate(t,e){return JSON.stringify(this.props)!=JSON.stringify(t)}render(){return console.log("Pager rendered"),null==this.state.taskcount?null:React.createElement("div",{id:"paginator",key:"paginator"},React.createElement("p",{key:"pagedescription"},"Showing ",this.state.pagetaskcount," of ",this.state.taskcount," tasks"),React.createElement("ul",{key:"prevnext",className:"pager"},null!=this.state.previous?React.createElement("li",{key:"previous",className:"previous"},React.createElement("a",{onClick:()=>{this.props.updateCursor(this.state.previous_cursor)},style:{cursor:"pointer"}},"« Newer")):null,null!=this.state.next?React.createElement("li",{key:"next",className:"next"},React.createElement("a",{onClick:()=>{this.props.updateCursor(this.state.next_cursor)},style:{cursor:"pointer"}},"Older »")):null))}}class TaskList extends React.Component{constructor(t){super(t),this.state={taskcount:null,results:null,status:"Loading...",api_url:t.api_url},this.updateCursor=this.updateCursor.bind(this),this.fetchData=this.fetchData.bind(this)}updateCursor(t){console.log("TaskList cursor changed to ",t);var e=new URL(window.location.href);null!=t&&e.searchParams.set("cursor",t),this.setState({api_url:e.toString()});var s=new URL(window.location.href);null!=t&&s.searchParams.set("cursor",t),window.history.pushState({},document.title,s),this.fetchData(!0)}fetchData(t){console.log("Fetching data from ",this.state.api_url),fetch(this.state.api_url,{headers:{Accept:"application/json","Content-Type":"application/json"}}).then((t=>t.json())).then((e=>{e.hasOwnProperty("results")?this.setState(e):this.setState({results:[e]}),t&&window.scrollTo(0,0)}))}componentDidMount(){this.fetchData(!1),this.interval=setInterval((()=>this.fetchData()),2e3)}componentWillUnmount(){clearInterval(this.interval)}render(){if(null==this.state.results)return React.createElement("p",null,"Loading tasks...");if(0==this.state.results.length)return React.createElement("p",null,"There are no tasks.");var t=null!=this.state.results?this.state.results.length:null;return React.createElement("div",null,React.createElement("ul",{key:"tasklist",className:"tasks"},this.state.results.map((t=>React.createElement(Task,{key:t.id,taskdata:t,fetchData:this.fetchData})))),React.createElement(Pager,{key:"pager",previous:this.state.previous,next:this.state.next,pagetaskcount:t,taskcount:this.state.taskcount,updateCursor:this.updateCursor}))}}ReactDOM.render(React.createElement(TaskList,{api_url:api_url}),document.getElementById("tasklist"));
